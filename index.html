<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>世界遺産マップ</title>
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 5;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        max-height: 80vh;
        overflow-y: auto;
        font-size: 14px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw=initMap" defer></script>
    <script>
      let map;
      let markers = [];
      let markerMap = new Map();

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 45.8910, lng: 10.1784 },
          zoom: 6,
        });

        fetch("places.csv")
          .then((response) => response.text())
          .then((csv) => {
            const lines = csv.trim().split("\n").slice(1);
            const countries = new Set();
            const data = lines.map(line => {
              const [country, site, lat, lng, type, year, jp, en, url] = line.split(",");
              countries.add(country);
              return { country, site, lat: parseFloat(lat), lng: parseFloat(lng), type, year, jp, en, url };
            });

            data.forEach(({ country, site, lat, lng, type, year, jp, en, url }) => {
              const label = site.slice(0, 2);
              const marker = new google.maps.Marker({
                position: { lat, lng },
                map,
                label: {
                  text: label,
                  color: 'black',
                  fontSize: '12px',
                  fontWeight: '400'
                },
                title: jp,
              });
              const content = `<div><strong>${jp}</strong><br>${en}<br><a href='${url}' target='_blank'>詳細を見る</a></div>`;
              const infowindow = new google.maps.InfoWindow({ content });
              marker.addListener("click", () => {
                infowindow.open(map, marker);
              });
              markers.push(marker);
              if (!markerMap.has(site)) markerMap.set(site, []);
              markerMap.get(site).push(marker);
            });

            // 国別セレクタ
            const countrySelect = document.getElementById("countrySelect");
            Array.from(countries).sort().forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c;
              opt.textContent = c;
              countrySelect.appendChild(opt);
            });

            // 遺産名セレクタ
            const placeSelect = document.getElementById("placeSelect");

            countrySelect.addEventListener("change", () => {
              const selected = countrySelect.value;
              placeSelect.innerHTML = '<option value="">-- 選択してください --</option>';
              const filtered = data.filter(d => !selected || d.country === selected);
              const seen = new Set();
              filtered.forEach(d => {
                if (!seen.has(d.site)) {
                  seen.add(d.site);
                  const opt = document.createElement("option");
                  opt.value = d.site;
                  opt.textContent = d.site;
                  placeSelect.appendChild(opt);
                }
              });
            });

            placeSelect.addEventListener("change", () => {
              const selectedSite = placeSelect.value;
              if (markerMap.has(selectedSite)) {
                const m = markerMap.get(selectedSite)[0];
                map.setCenter(m.getPosition());
                map.setZoom(13);
                google.maps.event.trigger(m, 'click');
              }
            });

          });
      }
    </script>
  </head>
  <body>
    <div class="controls">
      <label for="countrySelect">国を選択：</label>
      <select id="countrySelect">
        <option value="">-- 全て表示 --</option>
      </select><br />
      <label for="placeSelect">遺産を選択：</label>
      <select id="placeSelect">
        <option value="">-- 選択してください --</option>
      </select>
    </div>
    <div id="map"></div>
  </body>
</html>

