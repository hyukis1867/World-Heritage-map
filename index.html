<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>世界遺産マップ</title>
  <style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  .infowindow-localname {
    text-align: right;
    font-size: 90%;
    color: #555;
    margin-top: 2px;
  }
  .infowindow-sub {
    text-align: right;
    font-size: 85%;
    color: #444;
    margin-top: 4px;
  }
  /* クローズボタン（❌）を非表示にする */
  .gm-style-iw button.gm-ui-hover-effect {
    display: none !important;
  }
  /* ここからプルダウン用スタイル */
  #dropdown-container {
    position: absolute;
    top: 60px; /* ここで少し下に調整 */
    left: 10px;
    z-index: 5;
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }
  #dropdown-container select {
    margin-bottom: 5px;
    width: 200px;
    font-size: 14px;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- プルダウン追加 -->
  <div id="dropdown-container">
    <select id="country-select">
      <option value="">-- 国を選択 --</option>
    </select>
    <br>
    <select id="heritage-select" disabled>
      <option value="">-- 遺産を選択 --</option>
    </select>
  </div>

  <script>
    let map;
    let markers = [];
    let infoWindow = null;
    let lastOpenedMarker = null;

    const iconColors = {
      "文化遺産": "orange",
      "自然遺産": "limegreen",
      "複合遺産": "deepskyblue"
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 41.9028, lng: 12.4964},
        zoom: 4,
        gestureHandling: 'greedy',
        tilt: 0
      });

      const savedCenter = localStorage.getItem('mapCenter');
      const savedZoom = localStorage.getItem('mapZoom');
      if (savedCenter && savedZoom) {
        const center = JSON.parse(savedCenter);
        map.setCenter(center);
        map.setZoom(parseInt(savedZoom));
      }

      map.addListener('center_changed', () => {
        localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
      });
      map.addListener('zoom_changed', () => {
        localStorage.setItem('mapZoom', map.getZoom());
      });

      fetch('places.csv')
      .then(response => response.text())
      .then(csv => {
        const rows = csv.trim().split('\n').slice(1);

        /* 
          データ構造：
          idMap = {
            ID_No: {
              country: string,
              heritageName: string,
              markers: [marker1, marker2, ...],
              label: string,
              type: string,
              year: string
            },
            ...
          }
          countryIDMap = {
            countryName: Set of ID_No,
            ...
          }
        */

        const idMap = {};
        const countryIDMap = {};

        rows.forEach(row => {
          const columns = row.split(',');
          const idNo = columns[0];
          const country = columns[1];
          const heritageName = columns[2];
          const lat = parseFloat(columns[3]);
          const lng = parseFloat(columns[4]);
          const type = columns[5].trim();
          const year = columns[6];
          const localNameJP = columns[7]?.trim();
          const localNameEN = columns[8]?.trim();
          const linkUrl = columns[9]?.trim();

          // idMap初期化
          if (!idMap[idNo]) {
            idMap[idNo] = {
              country,
              heritageName,
              markers: [],
              label: '', // 後で決める
              type,
              year,
              localNameJP,
              localNameEN,
              linkUrl
            };
          }

          // countryIDMap初期化
          if (!countryIDMap[country]) countryIDMap[country] = new Set();
          countryIDMap[country].add(idNo);

          // マーカー作成
          const marker = new google.maps.Marker({
            position: {lat, lng},
            map,
            label: {
              text: '', // 後で設定
              color: 'black',
              fontSize: '12px',
              fontWeight: 'normal'
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: iconColors[type] || "gray",
              fillOpacity: 1,
              strokeColor: 'black',
              strokeWeight: 1,
              scale: 10
            },
            title: heritageName,
            customID: idNo,
            customCountry: country
          });

          marker.addListener("click", (event) => {
            if (event.domEvent && event.domEvent.shiftKey) {
              const params = new URLSearchParams({
                lat: lat.toFixed(6),
                lng: lng.toFixed(6),
                zoom: map.getZoom(),
                place: encodeURIComponent(heritageName)
              });
              const url = `${location.origin}${location.pathname}?${params.toString()}`;
              navigator.clipboard.writeText(url).then(() => {
                alert(`URLをコピーしました:\n${url}`);
              });
              return;
            }

            if (lastOpenedMarker === marker && infoWindow) {
              infoWindow.close();
              lastOpenedMarker = null;
              return;
            }

            const nameHtml = linkUrl
              ? `<a href="${linkUrl}" target="_blank">${heritageName}</a>`
              : `${heritageName}`;

            const localNameHtmlJP = localNameJP
              ? `<div class="infowindow-localname">${localNameJP}</div>`
              : '';

            const localNameHtmlEN = localNameEN
              ? `<div class="infowindow-localname">${localNameEN}</div>`
              : '';

            const subInfo = `<div class="infowindow-sub">${country} / ${type} / ${year}年登録</div>`;

            const contentHtml = `
              <div>
                <strong>${nameHtml}</strong>
                ${localNameHtmlJP}
                ${localNameHtmlEN}
                ${subInfo}
              </div>
            `;

            if (infoWindow) infoWindow.close();
            infoWindow = new google.maps.InfoWindow({
              content: contentHtml
            });
            infoWindow.open(map, marker);
            lastOpenedMarker = marker;
          });

          idMap[idNo].markers.push(marker);
          markers.push(marker);
        });

        // IDごとにラベルを決定（国内で一意の数字ラベル）
        Object.entries(countryIDMap).forEach(([country, idSet]) => {
          // 数字ラベルを1から割り振る
          const ids = Array.from(idSet);
          ids.forEach((id, index) => {
            idMap[id].label = (index + 1).toString();
            // マーカーすべてにラベル反映
            idMap[id].markers.forEach(marker => {
              marker.setLabel({
                text: idMap[id].label,
                color: 'black',
                fontSize: '12px',
                fontWeight: 'normal'
              });
            });
          });
        });

        // MarkerClustererの設定（クラスター時は純正アイコンで数字のみ）
        const markerCluster = new markerClusterer.MarkerClusterer({ 
          map, 
          markers,
          maxZoom: 10
        });

        // プルダウン要素取得
        const countrySelect = document.getElementById('country-select');
        const heritageSelect = document.getElementById('heritage-select');

        // 国プルダウンに国名を追加
        const sortedCountries = Object.keys(countryIDMap).sort();
        sortedCountries.forEach(country => {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          countrySelect.appendChild(option);
        });

        // 国選択時処理
        countrySelect.addEventListener('change', () => {
          const selectedCountry = countrySelect.value;

          // 遺産プルダウン初期化
          heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';
          heritageSelect.disabled = true;

          // まずすべてのマーカー非表示
          markers.forEach(marker => marker.setMap(null));

          if (!selectedCountry) {
            // 国未選択ならすべて表示
            markers.forEach(marker => marker.setMap(map));
            return;
          }

          // 選択国のID一覧を取得し、遺産プルダウンへIDごとに遺産名を追加
          const idList = Array.from(countryIDMap[selectedCountry]).sort((a,b) => {
            // 数字的にソート（IDは数値文字列想定）
            return parseInt(a) - parseInt(b);
          });
          idList.forEach(id => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = idMap[id].heritageName;
            heritageSelect.appendChild(opt);
          });
          heritageSelect.disabled = false;

          // 選択国のマーカーだけ表示
          idList.forEach(id => {
            idMap[id].markers.forEach(marker => marker.setMap(map));
          });
        });

        // 遺産選択時処理（ID単位）
        heritageSelect.addEventListener('change', () => {
          const selectedId = heritageSelect.value;
          if (!selectedId) return;

          const idData = idMap[selectedId];
          if (!idData) return;

          const mainMarker = idData.markers[0]; // 代表マーカー（配列先頭）

          // 少しズームアウト気味に調整
          map.setZoom(8);
          map.panTo(mainMarker.getPosition());

          // 吹き出し表示
          google.maps.event.trigger(mainMarker, 'click');
        });

        // URL指定マーカー自動表示
        const urlParams = new URLSearchParams(window.location.search);
        const urlLat = parseFloat(urlParams.get('lat'));
        const urlLng = parseFloat(urlParams.get('lng'));
        const urlZoom = parseInt(urlParams.get('zoom'));
        const targetPlace = urlParams.get('place');

        if (!isNaN(urlLat) && !isNaN(urlLng) && !isNaN(urlZoom)) {
          map.setCenter({ lat: urlLat, lng: urlLng });
          map.setZoom(urlZoom);
        }

        if (targetPlace) {
          const decodedPlace = decodeURIComponent(targetPlace);
          setTimeout(() => {
            // targetPlaceは遺産名なのでidMapから該当遺産名のIDを探す
            let foundId = null;
            for (const id in idMap) {
              if (idMap[id].heritageName === decodedPlace) {
                foundId = id;
                break;
              }
            }
            if (foundId) {
              const mainMarker = idMap[foundId].markers[0];
              google.maps.event.trigger(mainMarker, 'click');
            }
          }, 500);
        }
      });
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap">
  </script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>

