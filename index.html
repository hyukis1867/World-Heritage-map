<!-- 修正点を以下に適用：
1. 地域セレクトボックスを追加
2. 地域→国→遺産の三段階連動セレクトに対応
3. CSVは [ID, 地域, 国, 遺産名, ...] を想定 -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>世界遺産マップ</title>
  <style>
  html, body, #map {
    height: 100%; margin: 0; padding: 0; overflow: hidden;
  }
  .infowindow-localname {
    text-align: right; font-size: 90%; color: #555; margin-top: 2px;
  }
  .infowindow-sub {
    text-align: right; font-size: 85%; color: #444; margin-top: 4px;
  }
  .gm-style-iw button.gm-ui-hover-effect {
    display: none !important;
  }
  #dropdown-container {
    position: absolute; top: 60px; left: 10px; z-index: 5;
    background: white; padding: 8px; border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }
  #dropdown-container select {
    margin-bottom: 5px; width: 200px; font-size: 14px;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="dropdown-container">
    <select id="region-select">
      <option value="">-- 地域を選択 --</option>
    </select><br>
    <select id="country-select" disabled>
      <option value="">-- 国を選択 --</option>
    </select><br>
    <select id="heritage-select" disabled>
      <option value="">-- 遺産を選択 --</option>
    </select>
  </div>

  <script>
    let map;
    let markers = [];
    let infoWindow = null;
    let lastOpenedMarker = null;
    let heritageData = [];
    const iconColors = {"文化遺産": "orange", "自然遺産": "limegreen", "複合遺産": "deepskyblue"};

    function showInfo(marker) { /* 略（変更なし） */ }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 41.9028, lng: 12.4964}, zoom: 4, gestureHandling: 'greedy', tilt: 0
      });

      // ローカルストレージ対応 略

      fetch('places.csv')
      .then(response => response.text())
      .then(csv => {
        const rows = csv.trim().split('\n').slice(1);
        const regionMap = {};

        rows.forEach(row => {
          const columns = row.split(',');
          const id = columns[0];
          const region = columns[1];
          const country = columns[2];
          const heritageName = columns[3];
          const lat = parseFloat(columns[4]);
          const lng = parseFloat(columns[5]);
          const type = columns[6]?.trim();
          const year = columns[7];
          const localNameJP = columns[8]?.trim();
          const localNameEN = columns[9]?.trim();
          const linkUrl = columns[10]?.trim();

          heritageData.push({id, region, country, heritageName, lat, lng, type, year, localNameJP, localNameEN, linkUrl});

          if (!regionMap[region]) regionMap[region] = {};
          if (!regionMap[region][country]) regionMap[region][country] = {};
          regionMap[region][country][heritageName] = id;

          // マーカー生成 略（変更なし）
        });

        new markerClusterer.MarkerClusterer({ map, markers, maxZoom: 10, onClusterClick: () => false });

        const regionSelect = document.getElementById('region-select');
        const countrySelect = document.getElementById('country-select');
        const heritageSelect = document.getElementById('heritage-select');

        // 地域セレクト初期化
        Object.keys(regionMap).forEach(region => {
          const option = document.createElement('option');
          option.value = region;
          option.textContent = region;
          regionSelect.appendChild(option);
        });

        regionSelect.addEventListener('change', () => {
          const selectedRegion = regionSelect.value;
          countrySelect.innerHTML = '<option value="">-- 国を選択 --</option>';
          heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';
          heritageSelect.disabled = true;

          if (selectedRegion && regionMap[selectedRegion]) {
            Object.keys(regionMap[selectedRegion]).forEach(country => {
              const option = document.createElement('option');
              option.value = country;
              option.textContent = country;
              countrySelect.appendChild(option);
            });
            countrySelect.disabled = false;
          } else {
            countrySelect.disabled = true;
          }

          markers.forEach(marker => {
            marker.setVisible(!selectedRegion || marker.customRegion === selectedRegion);
          });
        });

        countrySelect.addEventListener('change', () => {
          const selectedRegion = regionSelect.value;
          const selectedCountry = countrySelect.value;

          heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';
          if (selectedCountry && regionMap[selectedRegion]?.[selectedCountry]) {
            Object.keys(regionMap[selectedRegion][selectedCountry]).forEach(heritage => {
              const id = regionMap[selectedRegion][selectedCountry][heritage];
              const option = document.createElement('option');
              option.value = `${id}.${heritage}`;
              option.textContent = `${id}.${heritage}`;
              heritageSelect.appendChild(option);
            });
            heritageSelect.disabled = false;
          } else {
            heritageSelect.disabled = true;
          }

          markers.forEach(marker => {
            marker.setVisible(!selectedCountry || marker.customCountry === selectedCountry);
          });
        });

        heritageSelect.addEventListener('change', () => {
          const selectedHeritage = heritageSelect.value;
          if (!selectedHeritage) return;
          const id = selectedHeritage.split('.')[0];
          const targetMarker = markers.find(marker => marker.customId === id);
          if (targetMarker) {
            if (infoWindow) infoWindow.close();
            map.setCenter(targetMarker.getPosition());
            map.setZoom(10);
            setTimeout(() => {
              google.maps.event.trigger(targetMarker, 'click');
            }, 400);
          }
        });

        // URLクエリ処理（略）
      });
    }
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap"></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>
