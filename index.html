<body>
  <select id="countryFilter" style="position: absolute; z-index: 5; top: 10px; left: 10px; font-size: 16px;">
    <option value="ALL">全ての国を表示</option>
  </select>
  <div id="map"></div>
  <script>
    let map;
    let markers = [];
    let infoWindow = null;
    let lastOpenedMarker = null;
    const countryToMarkers = {};
    const countrySet = new Set();

    const iconColors = {
      "文化遺産": "orange",
      "自然遺産": "limegreen",
      "複合遺産": "deepskyblue"
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 41.9028, lng: 12.4964},
        zoom: 4,
        gestureHandling: 'greedy',
        tilt: 0
      });

      const savedCenter = localStorage.getItem('mapCenter');
      const savedZoom = localStorage.getItem('mapZoom');
      if (savedCenter && savedZoom) {
        const center = JSON.parse(savedCenter);
        map.setCenter(center);
        map.setZoom(parseInt(savedZoom));
      }

      map.addListener('center_changed', () => {
        localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
      });
      map.addListener('zoom_changed', () => {
        localStorage.setItem('mapZoom', map.getZoom());
      });

      fetch('places.csv')
      .then(response => response.text())
      .then(csv => {
        const rows = csv.trim().split('\n').slice(1);
        const countryPlaceMap = {};

        rows.forEach(row => {
          const columns = row.split(',');
          const country = columns[0];
          const heritageName = columns[1];
          const lat = parseFloat(columns[2]);
          const lng = parseFloat(columns[3]);
          const type = columns[4].trim();
          const year = columns[5];
          const localNameJP = columns[6]?.trim();
          const localNameEN = columns[7]?.trim();
          const linkUrl = columns[8]?.trim();

          if (!countryPlaceMap[country]) {
            countryPlaceMap[country] = {};
          }
          const countryPlaces = countryPlaceMap[country];
          if (!countryPlaces[heritageName]) {
            countryPlaces[heritageName] = Object.keys(countryPlaces).length + 1;
          }

          const label = countryPlaces[heritageName].toString();
          const color = iconColors[type] || "gray";

          const marker = new google.maps.Marker({
            position: {lat, lng},
            map,
            label: {
              text: label,
              color: 'black',
              fontSize: '12px',
              fontWeight: 'normal'
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: color,
              fillOpacity: 1,
              strokeColor: 'black',
              strokeWeight: 1,
              scale: 10
            },
            title: heritageName
          });

          marker.country = country;

          marker.addListener("click", (event) => {
            if (event.domEvent && event.domEvent.shiftKey) {
              const params = new URLSearchParams({
                lat: lat.toFixed(6),
                lng: lng.toFixed(6),
                zoom: map.getZoom(),
                place: encodeURIComponent(heritageName)
              });
              const url = `${location.origin}${location.pathname}?${params.toString()}`;
              navigator.clipboard.writeText(url).then(() => {
                alert(`URLをコピーしました:\n${url}`);
              });
              return;
            }

            if (lastOpenedMarker === marker && infoWindow) {
              infoWindow.close();
              lastOpenedMarker = null;
              return;
            }

            const nameHtml = linkUrl
              ? `<a href="${linkUrl}" target="_blank">${heritageName}</a>`
              : heritageName;

            const localNameHtmlJP = localNameJP
              ? `<div class="infowindow-localname">${localNameJP}</div>`
              : '';

            const localNameHtmlEN = localNameEN
              ? `<div class="infowindow-localname">${localNameEN}</div>`
              : '';

            const subInfo = `<div class="infowindow-sub">${country} / ${type} / ${year}年登録</div>`;

            const contentHtml = 
              `<div>
                <strong>${nameHtml}</strong>
                ${localNameHtmlJP}
                ${localNameHtmlEN}
                ${subInfo}
              </div>`;

            if (infoWindow) infoWindow.close();
            infoWindow = new google.maps.InfoWindow({
              content: contentHtml
            });
            infoWindow.open(map, marker);
            lastOpenedMarker = marker;
          });

          markers.push(marker);

          // 国別マーカー格納
          if (!countryToMarkers[country]) countryToMarkers[country] = [];
          countryToMarkers[country].push(marker);
          countrySet.add(country);
        });

        // ドロップダウンに国名追加
        const dropdown = document.getElementById('countryFilter');
        Array.from(countrySet).sort().forEach(country => {
          const opt = document.createElement('option');
          opt.value = country;
          opt.textContent = country;
          dropdown.appendChild(opt);
        });

        dropdown.addEventListener('change', (e) => {
          const selected = e.target.value;
          markers.forEach(marker => {
            if (selected === "ALL" || marker.country === selected) {
              marker.setMap(map);
            } else {
              marker.setMap(null);
            }
          });
        });

        const markerCluster = new markerClusterer.MarkerClusterer({ 
          map, 
          markers,
          maxZoom: 10
        });

        const urlParams = new URLSearchParams(window.location.search);
        const urlLat = parseFloat(urlParams.get('lat'));
        const urlLng = parseFloat(urlParams.get('lng'));
        const urlZoom = parseInt(urlParams.get('zoom'));
        const targetPlace = urlParams.get('place');

        if (!isNaN(urlLat) && !isNaN(urlLng) && !isNaN(urlZoom)) {
          map.setCenter({ lat: urlLat, lng: urlLng });
          map.setZoom(urlZoom);
        }

        if (targetPlace) {
          const decodedPlace = decodeURIComponent(targetPlace);
          setTimeout(() => {
            const targetMarker = markers.find(m => m.title === decodedPlace);
            if (targetMarker) {
              google.maps.event.trigger(targetMarker, 'click', {
                domEvent: { shiftKey: false }
              });
            }
          }, 500);
        }
      });
    }
    <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=あなたのAPIキー&callback=initMap">
  </script>


