<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>世界遺産マップ</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .gm-ui-hover-effect {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    let map;
    let markers = [];
    let infoWindow = null;

    const lastCenterKey = "mapCenter";
    const lastZoomKey = "mapZoom";

    // アイコンの色をタイプに応じて指定
    const iconColors = {
      "文化遺産": "orange",
      "自然遺産": "green",
      "複合遺産": "deepskyblue"
    };

    function initMap() {
      // ローカルストレージから保存位置を取得、なければローマ中心に
      const savedCenter = JSON.parse(localStorage.getItem(lastCenterKey));
      const savedZoom = parseInt(localStorage.getItem(lastZoomKey));

      const defaultCenter = { lat: 41.8902, lng: 12.4922 }; // ローマ

      map = new google.maps.Map(document.getElementById('map'), {
        center: savedCenter || defaultCenter,
        zoom: savedZoom || 6
      });

      // 地図のidleイベントで現在位置とズームを保存
      map.addListener("idle", () => {
        const center = map.getCenter();
        localStorage.setItem(lastCenterKey, JSON.stringify({ lat: center.lat(), lng: center.lng() }));
        localStorage.setItem(lastZoomKey, map.getZoom());
      });

      fetch('places.csv')
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split('\n').slice(1); // ヘッダー除去
          const countryCounts = {};

          rows.forEach(row => {
            const [country, place, lat, lng, type] = row.split(',');

            if (!countryCounts[country]) countryCounts[country] = 1;
            else countryCounts[country]++;

            const label = countryCounts[country].toString();

            const color = iconColors[type.trim()] || "gray";
            const fillOpacity = (type.trim() === "自然遺産") ? 0.6 : 1;

            const marker = new google.maps.Marker({
              position: {lat: parseFloat(lat), lng: parseFloat(lng)},
              map,
              label,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: color,
                fillOpacity: fillOpacity,
                strokeColor: "black",
                strokeWeight: 1,
                scale: 10
              },
              title: place
            });

            marker.addListener("click", () => {
              if (infoWindow && infoWindow.anchor === marker) {
                infoWindow.close();
                infoWindow = null;
              } else {
                if (infoWindow) infoWindow.close();
                infoWindow = new google.maps.InfoWindow({ content: place });
                infoWindow.open(map, marker);
              }
            });

            markers.push(marker);
          });
        });
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap">
  </script>
</body>
</html>


