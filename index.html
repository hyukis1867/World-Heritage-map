<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>世界遺産マップ</title>
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .infowindow-localname {
        font-style: italic;
        color: #555;
      }
      .infowindow-sub {
        font-size: small;
        color: #999;
      }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw"></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 2,
        center: { lat: 20, lng: 0 },
      });

      const infoWindow = new google.maps.InfoWindow();
      let lastOpenedMarker = null;
      const markers = [];

      fetch("places.csv")
        .then(response => response.text())
        .then(csvText => {
          const rows = csvText.trim().split("\n");
          for (let i = 1; i < rows.length; i++) {
            const [id, country, name, lat, lng, type, year, localNameJP, localNameEN, url] = rows[i].split(',');
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(lat), lng: parseFloat(lng) },
              map,
              label: id,
              title: name,
              customCountry: country
            });
            marker.customId = id;
            markers.push(marker);

            marker.addListener("click", () => {
              if (infoWindow) infoWindow.close();

              const localNameHtmlJP = localNameJP
                ? `<div class="infowindow-localname">${localNameJP}</div>`
                : '';

              const localNameHtmlEN = localNameEN
                ? `<div class="infowindow-localname">${localNameEN}</div>`
                : '';

              const subInfo = `<div class="infowindow-sub">${country}</div>`;

              const contentHtml = `
                <div>
                  <strong>${name}</strong>
                  ${localNameHtmlJP}
                  ${localNameHtmlEN}
                  ${subInfo}
                </div>
              `;

              infoWindow.setContent(contentHtml);
              infoWindow.open(map, marker);
              lastOpenedMarker = marker;
            });
          }

          new markerClusterer.MarkerClusterer({ map, markers });

          const urlParams = new URLSearchParams(window.location.search);
          const targetPlace = urlParams.get("q");

          if (targetPlace) {
            const decodedPlace = decodeURIComponent(targetPlace);
            setTimeout(() => {
              const targetMarker = markers.find(m => m.title === decodedPlace);
              if (targetMarker) {
                if (infoWindow) infoWindow.close();

                const nameHtml = targetMarker.title;
                const country = targetMarker.customCountry;
                const id = targetMarker.customId;

                const localNameJP = "";
                const localNameEN = "";
                const type = "";
                const year = "";
                const linkUrl = "";

                const localNameHtmlJP = localNameJP
                  ? `<div class="infowindow-localname">${localNameJP}</div>`
                  : '';

                const localNameHtmlEN = localNameEN
                  ? `<div class="infowindow-localname">${localNameEN}</div>`
                  : '';

                const subInfo = `<div class="infowindow-sub">${country}</div>`;

                const contentHtml = `
                  <div>
                    <strong>${nameHtml}</strong>
                    ${localNameHtmlJP}
                    ${localNameHtmlEN}
                    ${subInfo}
                  </div>
                `;

                infoWindow.setContent(contentHtml);
                infoWindow.open(map, targetMarker);
                lastOpenedMarker = targetMarker;

                map.setZoom(Math.max(map.getZoom(), 8));
                map.panTo(targetMarker.getPosition());
              }
            }, 500);
          }
        });
    </script>
  </body>
</html>
