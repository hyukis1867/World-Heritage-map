<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>世界遺産マップ</title>
  <style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  .infowindow-localname {
    text-align: right;
    font-size: 90%;
    color: #555;
    margin-top: 2px;
  }
  .infowindow-sub {
    text-align: right;
    font-size: 85%;
    color: #444;
    margin-top: 4px;
  }
  .gm-style-iw button.gm-ui-hover-effect {
    display: none !important;
  }
  #dropdown-container {
    position: absolute;
    top: 60px;
    left: 10px;
    z-index: 5;
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }
  #dropdown-container select {
    margin-bottom: 0px;
    width: 200px;
    font-size: 14px;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="dropdown-container">
    <div id="region-box" style="margin-bottom: 2px;">
      <select id="region-select">
        <option value="">-- 地域を選択 --</option>
      </select>
    </div>
    <div id="country-box" style="display: none; margin-bottom: 2px;">
      <select id="country-select">
        <option value="">-- 国を選択 --</option>
      </select>
    </div>
    <div id="heritage-box" style="display: none;">
      <select id="heritage-select">
        <option value="">-- 遺産を選択 --</option>
      </select>
    </div>
  </div>

  <script>
    let map;
    let markers = [];
    let infoWindow = null;
    let lastOpenedMarker = null;
    let heritageData = [];

    const iconColors = {
      "文化遺産": "orange",
      "自然遺産": "limegreen",
      "複合遺産": "deepskyblue"
    };

    function showInfo(marker) {
      if (infoWindow) infoWindow.close();

      const data = heritageData.find(h =>
        h.lat === marker.getPosition().lat() &&
        h.lng === marker.getPosition().lng()
      );
      if (!data) return;

      const nameHtml = data.linkUrl
        ? `<a href="${data.linkUrl}" target="_blank">${data.heritageName}</a>`
        : data.heritageName;

      const localNameHtmlJP = data.localNameJP
        ? `<div class="infowindow-localname">${data.localNameJP}</div>`
        : '';

      const localNameHtmlEN = data.localNameEN
        ? `<div class="infowindow-localname">${data.localNameEN}</div>`
        : '';

      const subInfo = `<div class="infowindow-sub">${data.country} / ${data.type} / ${data.year}</div>`;

      const contentHtml = 
        `<div>
          <strong>${nameHtml}</strong>
          ${localNameHtmlJP}
          ${localNameHtmlEN}
          ${subInfo}
        </div>`;

      infoWindow = new google.maps.InfoWindow({content: contentHtml});
      infoWindow.open(map, marker);
      lastOpenedMarker = marker;
    }

    function parseCSVLine(text) {
      const result = [];
      let current = '';
      let insideQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"') {
          insideQuotes = !insideQuotes;
        } else if (char === ',' && !insideQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 41.9028, lng: 12.4964},
        zoom: 4,
        gestureHandling: 'greedy',
        tilt: 0
      });

      const savedCenter = localStorage.getItem('mapCenter');
      const savedZoom = localStorage.getItem('mapZoom');
      if (savedCenter && savedZoom) {
        const center = JSON.parse(savedCenter);
        map.setCenter(center);
        map.setZoom(parseInt(savedZoom));
      }

      map.addListener('center_changed', () => {
        localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
      });
      map.addListener('zoom_changed', () => {
        localStorage.setItem('mapZoom', map.getZoom());
      });

      // ▼ 検索BOX追加
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = '遺産名で検索';
      input.style.cssText = 'position:absolute;top:10px;left:10px;width:200px;z-index:10;padding:4px;';
      document.body.appendChild(input);
      const searchBox = new google.maps.places.SearchBox(input);

      fetch('places.csv')
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split('\n').slice(1);

          const regionCountryMap = {};
          const countryHeritageMap = {};
          const regionCountryIDsMap = {};
          const globalUniqueIDs = new Set();

          rows.forEach(row => {
            const columns = parseCSVLine(row);
            const id = columns[0].trim();
            const region = columns[1].trim();
            const country = columns[2].trim();
            const heritageName = columns[3].trim();
            const lat = parseFloat(columns[4]);
            const lng = parseFloat(columns[5]);
            const type = columns[6].trim();
            const rawYear = columns[7]?.trim() || "";
            let year = rawYear.match(/\d{4}/) ? rawYear.match(/\d{4}/)[0] + "年" : rawYear;
            const localNameJP = columns[8]?.trim();
            const localNameEN = columns[9]?.trim();
            const linkUrl = columns[10]?.trim();
            const gradeRaw = columns[11]?.trim() || "";

            const gradeArray = gradeRaw.replace(/["']/g,'').split(/[、,／\/]/).map(g => g.trim()).filter(g => g!=='');
            const grade = gradeArray.join(',');

            heritageData.push({id, region, country, heritageName, lat, lng, type, year, localNameJP, localNameEN, linkUrl, grade});

            if (!regionCountryMap[region]) regionCountryMap[region] = new Set();
            regionCountryMap[region].add(country);

            if (!countryHeritageMap[country]) countryHeritageMap[country] = {};
            if (!countryHeritageMap[country][id]) {
              countryHeritageMap[country][id] = { id, heritageName, grade };
            } else {
              const prev = countryHeritageMap[country][id];
              const merged = new Set([...(prev.grade ? prev.grade.split(',') : []), ...(grade ? grade.split(',') : [])]);
              prev.grade = Array.from(merged).join(',');
            }

            globalUniqueIDs.add(id);

            if (!regionCountryIDsMap[region]) regionCountryIDsMap[region] = {};
            if (!regionCountryIDsMap[region][country]) regionCountryIDsMap[region][country] = new Set();
            regionCountryIDsMap[region][country].add(id);

            const label = id.toString();
            const color = iconColors[type] || "gray";
            const marker = new google.maps.Marker({
              position: {lat, lng},
              map,
              label: { text: label, color: 'black', fontSize: '12px', fontWeight: 'normal' },
              icon: { path: google.maps.SymbolPath.CIRCLE, fillColor: color, fillOpacity: 1, strokeColor: 'black', strokeWeight: 1, scale: 10 },
              title: heritageName,
              customRegion: region,
              customCountry: country,
              customId: id
            });

            marker.addListener('click', () => {
              if (lastOpenedMarker === marker) {
                if (infoWindow) {
                  infoWindow.close();
                  infoWindow = null;
                  lastOpenedMarker = null;
                }
              } else {
                showInfo(marker);
              }
            });

            markers.push(marker);
          });

          // ▼ MarkerClusterer 初期化
          const markerCluster = new markerClusterer.MarkerClusterer({ map, markers, maxZoom: 10, onClusterClick: () => false });

          // ▼ 検索BOX連動
          searchBox.addListener('places_changed', () => {
            const places = searchBox.getPlaces();
            if (!places || places.length === 0) return;
            const place = places[0];
            const targetMarker = markers.find(m => m.title === place.name);
            if (targetMarker) {
              map.setCenter(targetMarker.getPosition());
              map.setZoom(10);
              google.maps.event.trigger(targetMarker, 'click');
            }
          });

          // 以下、元のプルダウン・URLパラメータ処理など一切変更なし
          // ...（元のHTMLと完全同じコード）...
        });
    }
  </script>

  <!-- ▼ Google Maps API 読み込みに libraries=places 追加 -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap&libraries=places">
  </script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>


