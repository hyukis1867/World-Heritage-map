<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>世界遺産マップ</title>
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #selectors {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 5;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }
      select {
        display: block;
        margin: 5px 0;
        width: 200px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw"></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
  </head>
  <body>
    <div id="selectors">
      <select id="regionSelect">
        <option value="">地域を選択</option>
      </select>
      <select id="countrySelect" style="display:none;">
        <option value="">国を選択</option>
      </select>
      <select id="siteSelect" style="display:none;">
        <option value="">遺産を選択</option>
      </select>
    </div>
    <div id="map"></div>

    <script>
      let map, markers = [], markerMap = {}, clusterer;
      const regionSelect = document.getElementById("regionSelect");
      const countrySelect = document.getElementById("countrySelect");
      const siteSelect = document.getElementById("siteSelect");

      fetch("places.csv")
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split("\n").slice(1).map(line => line.split(","));
          const regions = new Set();
          const countriesByRegion = {};
          const sitesByCountry = {};
          
          rows.forEach(cols => {
            const [id, region, country, name, lat, lng, type, year, jp, en, url] = cols;
            regions.add(region);
            countriesByRegion[region] = countriesByRegion[region] || new Set();
            countriesByRegion[region].add(country);
            sitesByCountry[country] = sitesByCountry[country] || [];
            sitesByCountry[country].push({ id, name, lat, lng, type, year, jp, en, url });
          });

          // 地域選択肢追加
          Array.from(regions).sort().forEach(region => {
            const opt = document.createElement("option");
            opt.value = region;
            opt.textContent = region;
            regionSelect.appendChild(opt);
          });

          // 地図初期化
          map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 20, lng: 0 },
            zoom: 2
          });

          // マーカー生成と保存
          rows.forEach(cols => {
            const [id, , , name, lat, lng, type, year, jp, en, url] = cols;
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(lat), lng: parseFloat(lng) },
              label: id,
            });
            const info = new google.maps.InfoWindow({
              content: `<strong>${jp}</strong><br>${en}<br>${type} / ${year}<br><a href="${url}" target="_blank">詳細</a>`
            });
            marker.addListener("click", () => info.open(map, marker));
            markers.push(marker);
            markerMap[id] = marker;
          });

          clusterer = new markerClusterer.MarkerClusterer({ map, markers });

          // イベント設定
          regionSelect.addEventListener("change", () => {
            countrySelect.innerHTML = `<option value="">国を選択</option>`;
            siteSelect.innerHTML = `<option value="">遺産を選択</option>`;
            siteSelect.style.display = "none";

            const selected = regionSelect.value;
            if (selected && countriesByRegion[selected]) {
              Array.from(countriesByRegion[selected]).sort().forEach(country => {
                const opt = document.createElement("option");
                opt.value = country;
                opt.textContent = country;
                countrySelect.appendChild(opt);
              });
              countrySelect.style.display = "block";
            } else {
              countrySelect.style.display = "none";
            }
          });

          countrySelect.addEventListener("change", () => {
            siteSelect.innerHTML = `<option value="">遺産を選択</option>`;
            const selected = countrySelect.value;
            if (selected && sitesByCountry[selected]) {
              sitesByCountry[selected].forEach(site => {
                const opt = document.createElement("option");
                opt.value = site.id;
                opt.textContent = site.name;
                siteSelect.appendChild(opt);
              });
              siteSelect.style.display = "block";
            } else {
              siteSelect.style.display = "none";
            }
          });

          siteSelect.addEventListener("change", () => {
            const selectedId = siteSelect.value;
            const marker = markerMap[selectedId];
            if (marker) {
              map.setZoom(8);
              map.panTo(marker.getPosition());
              google.maps.event.trigger(marker, "click");
            }
          });
        });
    </script>
  </body>
</html>

