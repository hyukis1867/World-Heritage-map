function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 41.9028, lng: 12.4964},
    zoom: 4
  });

  const savedCenter = localStorage.getItem('mapCenter');
  const savedZoom = localStorage.getItem('mapZoom');
  if (savedCenter && savedZoom) {
    const center = JSON.parse(savedCenter);
    map.setCenter(center);
    map.setZoom(parseInt(savedZoom));
  }

  map.addListener('center_changed', () => {
    localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
  });
  map.addListener('zoom_changed', () => {
    localStorage.setItem('mapZoom', map.getZoom());
  });

  fetch('places.csv')
    .then(response => response.text())
    .then(csv => {
      const rows = csv.trim().split('\n').slice(1);
      const countryPlaceMap = {};  // { 国名: { "地名": 番号 } }

      rows.forEach(row => {
        const [country, place, lat, lng, type, year] = row.split(',');

        if (!countryPlaceMap[country]) {
          countryPlaceMap[country] = {};
        }

        const countryPlaces = countryPlaceMap[country];
        if (!countryPlaces[place]) {
          countryPlaces[place] = Object.keys(countryPlaces).length + 1;
        }

        const label = countryPlaces[place].toString();
        const trimmedType = type.trim();
        const color = iconColors[trimmedType] || "gray";

        const marker = new google.maps.Marker({
          position: {lat: parseFloat(lat), lng: parseFloat(lng)},
          map,
          label,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: "black",
            strokeWeight: 1,
            scale: 10
          },
          title: place
        });

        marker.addListener("click", () => {
          if (infoWindow && infoWindow.anchor === marker) {
            infoWindow.close();
            infoWindow = null;
          } else {
            if (infoWindow) infoWindow.close();
            infoWindow = new google.maps.InfoWindow({
              content: `
                <div>
                  <strong>${place}</strong><br>
                  <small>${country} / ${trimmedType} / ${year}年登録</small>
                </div>
              `,
              maxWidth: 250
            });
            infoWindow.open(map, marker);
          }
        });

        markers.push(marker);
      });
    });
}
