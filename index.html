<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>世界遺産マップ</title>
  <style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  .infowindow-localname {
    text-align: right;
    font-size: 90%;
    color: #555;
    margin-top: 2px;
  }
  .infowindow-sub {
    text-align: right;
    font-size: 85%;
    color: #444;
    margin-top: 4px;
  }
  .gm-style-iw button.gm-ui-hover-effect {
    display: none !important;
  }
  #dropdown-container {
    position: absolute;
    top: 60px;
    left: 10px;
    z-index: 5;
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }
  #dropdown-container select {
    margin-bottom: 0px;
    width: 200px;
    font-size: 14px;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="dropdown-container">
    <div id="region-box" style="margin-bottom: 2px;">
      <select id="region-select">
        <option value="">-- 地域を選択 --</option>
      </select>
    </div>
    <div id="country-box" style="display: none; margin-bottom: 2px;">
      <select id="country-select">
        <option value="">-- 国を選択 --</option>
      </select>
    </div>
    <div id="heritage-box" style="display: none;">
      <select id="heritage-select">
        <option value="">-- 遺産を選択 --</option>
      </select>
    </div>
  </div>

<script>
let map;
let markers = [];
let infoWindow = null;
let lastOpenedMarker = null;
let heritageData = [];

const iconColors = {
  "文化遺産": "orange",
  "自然遺産": "limegreen",
  "複合遺産": "deepskyblue"
};

function showInfo(marker) {
  if (infoWindow) infoWindow.close();

  const data = heritageData.find(h =>
    h.lat === marker.getPosition().lat() &&
    h.lng === marker.getPosition().lng()
  );
  if (!data) return;

  const nameHtml = data.linkUrl
    ? `<a href="${data.linkUrl}" target="_blank">${data.heritageName}</a>`
    : data.heritageName;

  const localNameHtmlJP = data.localNameJP ? `<div class="infowindow-localname">${data.localNameJP}</div>` : '';
  const localNameHtmlEN = data.localNameEN ? `<div class="infowindow-localname">${data.localNameEN}</div>` : '';
  const subInfo = `<div class="infowindow-sub">${data.country} / ${data.type} / ${data.year}</div>`;

  const contentHtml = `<div>
    <strong>${nameHtml}</strong>
    ${localNameHtmlJP}
    ${localNameHtmlEN}
    ${subInfo}
  </div>`;

  infoWindow = new google.maps.InfoWindow({content: contentHtml});
  infoWindow.open(map, marker);
  lastOpenedMarker = marker;
}

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 41.9028, lng: 12.4964},
    zoom: 4,
    gestureHandling: 'greedy',
    tilt: 0
  });

  const savedCenter = localStorage.getItem('mapCenter');
  const savedZoom = localStorage.getItem('mapZoom');
  if (savedCenter && savedZoom) {
    const center = JSON.parse(savedCenter);
    map.setCenter(center);
    map.setZoom(parseInt(savedZoom));
  }

  map.addListener('center_changed', () => {
    localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
  });
  map.addListener('zoom_changed', () => {
    localStorage.setItem('mapZoom', map.getZoom());
  });

  fetch('places.csv')
    .then(response => response.text())
    .then(csv => {
      const rows = csv.trim().split('\n').slice(1);
      const regionCountryMap = {};
      const countryHeritageMap = {};
      const regionCountryIDsMap = {};

      rows.forEach(row => {
        const columns = row.split(',');
        const id = columns[0];
        const region = columns[1];
        const country = columns[2];
        const heritageName = columns[3];
        const lat = parseFloat(columns[4]);
        const lng = parseFloat(columns[5]);
        const type = columns[6].trim();
        const rawYear = columns[7]?.trim() || "";
        let year = "";
        const match = rawYear.match(/\d{4}/);
        if (match) { year = match[0] + "年"; } else { year = rawYear; }
        const localNameJP = columns[8]?.trim();
        const localNameEN = columns[9]?.trim();
        const linkUrl = columns[10]?.trim();
        const grade = columns[11]?.trim(); // 12列目の級

        heritageData.push({id, region, country, heritageName, lat, lng, type, year, localNameJP, localNameEN, linkUrl, grade});

        if (!regionCountryMap[region]) regionCountryMap[region] = new Set();
        regionCountryMap[region].add(country);

        if (!countryHeritageMap[country]) countryHeritageMap[country] = {};
        countryHeritageMap[country][heritageName] = { id, grade };

        if (!regionCountryIDsMap[region]) regionCountryIDsMap[region] = {};
        if (!regionCountryIDsMap[region][country]) regionCountryIDsMap[region][country] = new Set();
        regionCountryIDsMap[region][country].add(id);

        const color = iconColors[type] || "gray";
        const marker = new google.maps.Marker({
          position: {lat, lng},
          map,
          label: { text: id.toString(), color: 'black', fontSize: '12px', fontWeight: 'normal' },
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: 'black',
            strokeWeight: 1,
            scale: 10
          },
          title: heritageName,
          customRegion: region,
          customCountry: country,
          customId: id
        });

        marker.addListener('click', () => {
          if (lastOpenedMarker === marker) {
            if (infoWindow) { infoWindow.close(); infoWindow = null; lastOpenedMarker = null; }
          } else { showInfo(marker); }
        });

        markers.push(marker);
      });

      const regionSelect = document.getElementById('region-select');
      Object.keys(regionCountryMap).forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionSelect.appendChild(option);
      });

      const countrySelect = document.getElementById('country-select');
      const heritageSelect = document.getElementById('heritage-select');

      regionSelect.addEventListener('change', () => {
        const selectedRegion = regionSelect.value;
        document.getElementById("country-box").style.display = selectedRegion ? "block" : "none";
        document.getElementById("heritage-box").style.display = "none";

        countrySelect.innerHTML = '<option value="">-- 国を選択 --</option>';
        heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';

        if (selectedRegion && regionCountryMap[selectedRegion]) {
          const countriesArray = Array.from(regionCountryMap[selectedRegion]);
          countriesArray.sort((a,b)=>a.localeCompare(b,'ja'));
          countriesArray.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countrySelect.appendChild(option);
          });
        }

        markers.forEach(marker => { marker.setVisible(!selectedRegion || marker.customRegion === selectedRegion); });
      });

      countrySelect.addEventListener('change', () => {
        const selectedCountry = countrySelect.value;
        document.getElementById("heritage-box").style.display = selectedCountry ? "block" : "none";

        heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';
        if (selectedCountry && countryHeritageMap[selectedCountry]) {
          const heritages = countryHeritageMap[selectedCountry];
          Object.keys(heritages).forEach(heritage => {
            const { id, grade } = heritages[heritage];
            const option = document.createElement('option');
            option.value = `${selectedCountry}.${id}`;

            let gradeLabel = '';
            if (grade) {
              const grades = grade.split(',').map(g => `${g}級`);
              gradeLabel = `【${grades.join(',')}】`;
            }

            option.textContent = `${id}.${heritage} ${gradeLabel}`;
            heritageSelect.appendChild(option);
          });
        }

        markers.forEach(marker => { marker.setVisible(!selectedCountry || marker.customCountry === selectedCountry); });
      });

      heritageSelect.addEventListener('change', () => {
        const selectedHeritage = heritageSelect.value;
        if (!selectedHeritage) return;
        const [selectedCountry, id] = selectedHeritage.split('.');
        const targetMarker = markers.find(marker => marker.customCountry===selectedCountry && marker.customId===id);
        if (targetMarker) {
          if (infoWindow) { infoWindow.close(); infoWindow = null; lastOpenedMarker=null; }
          map.setCenter(targetMarker.getPosition());
          map.setZoom(10);
          google.maps.event.trigger(targetMarker,'click');
        }
      });
    });
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
</script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>
