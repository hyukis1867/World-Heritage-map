<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>世界遺産マップ</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .gm-ui-hover-effect {
      display: none !important; /* Closeボタン非表示 */
    }
    .custom-marker {
      color: white;
      font-size: 10px;
      border-radius: 50%;
      padding: 4px;
      border: 1px solid white;
      text-align: center;
      width: 24px;
      height: 24px;
      line-height: 16px;
      font-weight: bold;
      user-select: none;
      cursor: pointer;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap" async defer></script>
</head>
<body>
  <div id="map"></div>
  <script>
    let map;
    let openInfoWindow = null;
    const lastCenterKey = "mapCenter";
    const lastZoomKey = "mapZoom";

    // タイプに応じたマーカー色を返す関数
    function getColorByType(type) {
      switch(type) {
        case "文化遺産": return "#FFA500"; // オレンジ
        case "自然遺産": return "#4CAF50"; // 緑
        case "複合遺産": return "#00BFFF"; // 水色
        default: return "#FFA500"; // デフォルトはオレンジ
      }
    }

    function initMap() {
      const savedCenter = JSON.parse(localStorage.getItem(lastCenterKey));
      const savedZoom = parseInt(localStorage.getItem(lastZoomKey));

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: savedZoom || 3,
        center: savedCenter || { lat: 20, lng: 0 },
      });

      map.addListener("idle", () => {
        const center = map.getCenter();
        localStorage.setItem(lastCenterKey, JSON.stringify({ lat: center.lat(), lng: center.lng() }));
        localStorage.setItem(lastZoomKey, map.getZoom());
      });

      fetch(location.pathname.replace(/\/[^\/]*$/, '/') + 'places.csv')
        .then(response => response.text())
        .then(text => {
          const rows = text.trim().split("\n");
          const header = rows.shift(); // ヘッダー削除
          const countryCounters = {};
          const markers = [];

          rows.forEach(row => {
            const [country, name, latStr, lngStr, type] = row.split(",");
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            if (isNaN(lat) || isNaN(lng)) return;

            if (!countryCounters[country]) {
              countryCounters[country] = 1;
            } else {
              countryCounters[country]++;
            }
            const number = countryCounters[country];

            // マーカー用のdiv生成
            const div = document.createElement("div");
            div.className = "custom-marker";
            div.innerText = number;
            div.style.backgroundColor = getColorByType(type.trim());

            const marker = new google.maps.marker.AdvancedMarkerView({
              position: { lat, lng },
              map,
              content: div
            });

            const infoWindow = new google.maps.InfoWindow({
              content: name.trim()
            });

            marker.addListener("gmp-click", () => {
              if (openInfoWindow) {
                openInfoWindow.close();
                if (openInfoWindow === infoWindow) {
                  openInfoWindow = null;
                  return;
                }
              }
              infoWindow.open({ anchor: marker, map });
              openInfoWindow = infoWindow;
            });

            markers.push(marker);
          });
        });
    }
  </script>
</body>
</html>


