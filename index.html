<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>世界遺産マップ</title>
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      #search-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 5;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px;
        border-radius: 8px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="search-panel">
      <select id="countrySelect"><option value="">国を選択</option></select>
      <select id="heritageSelect"><option value="">遺産を選択</option></select>
    </div>
    <div id="map"></div>

    <!-- Google Maps API -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap"
      async defer>
    </script>

    <!-- ✅ 新しい MarkerClusterer (Google公式推奨の現行版) -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <script>
      let map;
      let markers = [];
      let markerCluster;
      let heritageData = [];

      async function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 46.8, lng: 8.2 },
          zoom: 7,
        });

        // CSVを読み込み
        const response = await fetch("places.csv");
        const csvText = await response.text();

        heritageData = csvText.trim().split("\n").slice(1).map(line => {
          const [id, country, name, lat, lng, type, year, localJP, localEN, url] = line.split(",");
          return { id, country, name, lat: parseFloat(lat), lng: parseFloat(lng), type, year, localJP, localEN, url };
        });

        // 国のリストを作成
        const countries = [...new Set(heritageData.map(d => d.country))].sort();
        const countrySelect = document.getElementById("countrySelect");
        countries.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          countrySelect.appendChild(opt);
        });

        // マーカーを作成
        heritageData.forEach(data => {
          const marker = new google.maps.Marker({
            position: { lat: data.lat, lng: data.lng },
            label: data.id,
          });

          const infowindow = new google.maps.InfoWindow({
            content: `
              <div style="font-size:14px">
                <b>${data.name}</b><br>
                ${data.country}<br>
                ${data.year}年登録<br>
                <a href="${data.url}" target="_blank">詳細を見る</a>
              </div>
            `,
          });

          marker.addListener("click", () => {
            infowindow.open(map, marker);
          });

          markers.push(marker);
        });

        console.log("マーカー数:", markers.length);

        // ✅ 新MarkerClustererでクラスタリング（SuperClusterAlgorithm使用）
        markerCluster = new markerClusterer.MarkerClusterer({
          map: map,
          markers: markers,
          algorithm: new markerClusterer.SuperClusterAlgorithm({
            maxZoom: 10,
          }),
        });

        // 国選択
        countrySelect.addEventListener("change", () => {
          const selectedCountry = countrySelect.value;
          const heritageSelect = document.getElementById("heritageSelect");
          heritageSelect.innerHTML = '<option value="">遺産を選択</option>';

          const filtered = heritageData.filter(d => !selectedCountry || d.country === selectedCountry);
          markers.forEach(m => m.setMap(null)); // 全て消す
          markers = [];

          filtered.forEach(d => {
            const marker = new google.maps.Marker({
              position: { lat: d.lat, lng: d.lng },
              label: d.id,
            });
            markers.push(marker);
          });

          // クラスタを更新
          markerCluster.clearMarkers();
          markerCluster.addMarkers(markers);

          filtered.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.name;
            opt.textContent = d.name;
            heritageSelect.appendChild(opt);
          });
        });

        // 遺産選択
        document.getElementById("heritageSelect").addEventListener("change", e => {
          const name = e.target.value;
          const data = heritageData.find(d => d.name === name);
          if (data) {
            map.setCenter({ lat: data.lat, lng: data.lng });
            map.setZoom(10);
          }
        });
      }
    </script>
  </body>
</html>


