<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>世界遺産マップ</title>
  <style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  .infowindow-localname {
    text-align: right;
    font-size: 90%;
    color: #555;
    margin-top: 2px;
  }
  .infowindow-sub {
    text-align: right;
    font-size: 85%;
    color: #444;
    margin-top: 4px;
  }
  .gm-style-iw button.gm-ui-hover-effect {
    display: none !important;
  }
  #dropdown-container {
    position: absolute;
    top: 60px;
    left: 10px;
    z-index: 5;
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }
  #dropdown-container select {
    margin-bottom: 0px;
    width: 200px;
    font-size: 14px;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="dropdown-container">
  <div id="region-box" style="margin-bottom: 2px;">
    <select id="region-select">
      <option value="">-- 地域を選択 --</option>
    </select>
  </div>
  <div id="country-box" style="display: none; margin-bottom: 2px;">
    <select id="country-select">
      <option value="">-- 国を選択 --</option>
    </select>
  </div>
  <div id="heritage-box" style="display: none;">
    <select id="heritage-select">
      <option value="">-- 遺産を選択 --</option>
    </select>
  </div>
</div>

  <script>
    let map;
    let markers = [];
    let infoWindow = null;
    let lastOpenedMarker = null;
    let heritageData = [];  // 全遺産データ保持用

    const iconColors = {
      "文化遺産": "orange",
      "自然遺産": "limegreen",
      "複合遺産": "deepskyblue"
    };

    function showInfo(marker) {
  if (infoWindow) infoWindow.close();

  const data = heritageData.find(h =>
    h.lat === marker.getPosition().lat() &&
    h.lng === marker.getPosition().lng()
  );
  if (!data) return;

  const nameHtml = data.linkUrl
    ? `<a href="${data.linkUrl}" target="_blank">${data.heritageName}</a>`
    : data.heritageName;

  const localNameHtmlJP = data.localNameJP
    ? `<div class="infowindow-localname">${data.localNameJP}</div>`
    : '';

  const localNameHtmlEN = data.localNameEN
    ? `<div class="infowindow-localname">${data.localNameEN}</div>`
    : '';

  const subInfo = `<div class="infowindow-sub">${data.country} / ${data.type} / ${data.year}年登録</div>`;

  const contentHtml = `
    <div>
      <strong>${nameHtml}</strong>
      ${localNameHtmlJP}
      ${localNameHtmlEN}
      ${subInfo}
    </div>
  `;

  infoWindow = new google.maps.InfoWindow({content: contentHtml});
  infoWindow.open(map, marker);
  lastOpenedMarker = marker;
}

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 41.9028, lng: 12.4964},
        zoom: 4,
        gestureHandling: 'greedy',
        tilt: 0
      });

      const savedCenter = localStorage.getItem('mapCenter');
      const savedZoom = localStorage.getItem('mapZoom');
      if (savedCenter && savedZoom) {
        const center = JSON.parse(savedCenter);
        map.setCenter(center);
        map.setZoom(parseInt(savedZoom));
      }

      map.addListener('center_changed', () => {
        localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
      });
      map.addListener('zoom_changed', () => {
        localStorage.setItem('mapZoom', map.getZoom());
      });

      fetch('places.csv')
      .then(response => response.text())
      .then(csv => {
        const rows = csv.trim().split('\n').slice(1);

        // 地域→国→遺産 の階層データ構造を作成
        const regionCountryMap = {}; // {region: Set of countries}
        const countryHeritageMap = {}; // {country: {heritageName: id}}

        rows.forEach(row => {
          const columns = row.split(',');
          const id = columns[0];
          const region = columns[1];     // 2列目：地域
          const country = columns[2];    // 3列目：国
          const heritageName = columns[3];
          const lat = parseFloat(columns[4]);
          const lng = parseFloat(columns[5]);
          const type = columns[6].trim();
          // 登録年加工
let year = columns[7] ? columns[7].trim() : "";

// 年だけ取り出す（4桁の数字）
const match = year.match(/\d{4}/);
if (match) {
  year = match[0] + "年";
} else {
  year = "";
}

          const localNameJP = columns[8]?.trim();
          const localNameEN = columns[9]?.trim();
          const linkUrl = columns[10]?.trim();

          heritageData.push({id, region, country, heritageName, lat, lng, type, year, localNameJP, localNameEN, linkUrl});

          if (!regionCountryMap[region]) regionCountryMap[region] = new Set();
          regionCountryMap[region].add(country);

          if (!countryHeritageMap[country]) countryHeritageMap[country] = {};
          countryHeritageMap[country][heritageName] = id;

          const label = id.toString();
          const color = iconColors[type] || "gray";

          const marker = new google.maps.Marker({
            position: {lat, lng},
            map,
            label: {
              text: label,
              color: 'black',
              fontSize: '12px',
              fontWeight: 'normal'
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: color,
              fillOpacity: 1,
              strokeColor: 'black',
              strokeWeight: 1,
              scale: 10
            },
            title: heritageName,
            customRegion: region,
            customCountry: country,
            customId: id
          });

          marker.addListener("click", (event) => {
            if (event.domEvent && event.domEvent.shiftKey) {
              const params = new URLSearchParams({
                lat: lat.toFixed(6),
                lng: lng.toFixed(6),
                zoom: map.getZoom(),
                place: encodeURIComponent(heritageName)
              });
              const url = `${location.origin}${location.pathname}?${params.toString()}`;
              navigator.clipboard.writeText(url).then(() => {
                alert(`URLをコピーしました:\n${url}`);
              });
              return;
            }

            if (lastOpenedMarker === marker && infoWindow) {
              infoWindow.close();
              lastOpenedMarker = null;
              return;
            }

            showInfo(marker);
          });

          markers.push(marker);
        });

        // マーカークラスタ
        const markerCluster = new markerClusterer.MarkerClusterer({
          map,
          markers,
          maxZoom: 10,
          onClusterClick: () => false
        });

        // セレクト要素取得
        const regionSelect = document.getElementById('region-select');
        const countrySelect = document.getElementById('country-select');
        const heritageSelect = document.getElementById('heritage-select');

        // 地域選択肢設定
        Object.keys(regionCountryMap).forEach(region => {
          const option = document.createElement('option');
          option.value = region;
          option.textContent = region;
          regionSelect.appendChild(option);
        });

        // 初期状態では国・遺産は選択不可
        countrySelect.disabled = true;
        heritageSelect.disabled = true;

        // 地域選択時処理
        regionSelect.addEventListener('change', () => {
          const selectedRegion = regionSelect.value;
          document.getElementById("country-box").style.display = selectedRegion ? "block" : "none";
          document.getElementById("heritage-box").style.display = "none";

          // 国名 → 国コード変換マップ（必要に応じて追加）
const countryCodeMap = {
  "日本": "JP",
  "中華人民共和国": "CN",
  "イタリア共和国": "IT",
  "フランス共和国": "FR",
  // 必要になったらここに追加
};

// 国コードを国旗絵文字に変換する関数
function getFlagEmojiFromName(countryName) {
  const code = countryCodeMap[countryName];
  if (!code) return ""; // 未登録なら空文字
  return code
    .toUpperCase()
    .split('')
    .map(char => 0x1F1E6 - 65 + char.charCodeAt(0))
    .map(cp => String.fromCodePoint(cp))
    .join('');
}

// 国の選択肢リセット＆無効化
countrySelect.innerHTML = '<option value="">-- 国を選択 --</option>';
countrySelect.disabled = !selectedRegion;

// 遺産選択肢リセット＆無効化
heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';
heritageSelect.disabled = true;

// 地域に紐づく国を追加
if (selectedRegion && regionCountryMap[selectedRegion]) {
  // Set を配列に変換
  const countriesArray = Array.from(regionCountryMap[selectedRegion]);

  // かな順ソート（日本語五十音順）
  countriesArray.sort((a, b) => a.localeCompare(b, 'ja'));

  countriesArray.forEach(country => {
    if (country && country.trim() !== '') {  // 空白や空文字を除外
      const option = document.createElement('option');
      option.value = country;
      // 国旗＋国名
      option.textContent = `${getFlagEmojiFromName(country)} ${country}`;
      countrySelect.appendChild(option);
    }
  });
}

          // マーカーの表示切替（地域フィルター）
          markers.forEach(marker => {
            marker.setVisible(!selectedRegion || marker.customRegion === selectedRegion);
          });

          // 遺産セレクト値クリア
          heritageSelect.value = '';
          // 国セレクト値クリア
          countrySelect.value = '';
        });

        // 国選択時処理
        countrySelect.addEventListener('change', () => {
          const selectedCountry = countrySelect.value;
          document.getElementById("heritage-box").style.display = selectedCountry ? "block" : "none";

          // 遺産の選択肢リセット
          heritageSelect.innerHTML = '<option value="">-- 遺産を選択 --</option>';
          heritageSelect.disabled = !selectedCountry;

          if (selectedCountry && countryHeritageMap[selectedCountry]) {
            const heritages = countryHeritageMap[selectedCountry];
            Object.keys(heritages).forEach(heritage => {
              const option = document.createElement('option');
              option.value = `${selectedCountry}.${heritages[heritage]}`; // 国.ID の組み合わせに変更
              option.textContent = `${heritages[heritage]}.${heritage}`;  // 表示はID.遺産名のまま
              heritageSelect.appendChild(option);
            });
          }

          // マーカーの表示切替（国フィルター）
          markers.forEach(marker => {
            marker.setVisible(!selectedCountry || marker.customCountry === selectedCountry);
          });

          // 遺産セレクト値クリア
          heritageSelect.value = '';
        });

        // 遺産選択時処理
        heritageSelect.addEventListener('change', () => {
          const selectedHeritage = heritageSelect.value;
          if (!selectedHeritage) return;

          // 国.ID の形式から分割
          const [selectedCountry, id] = selectedHeritage.split('.');
          if (!selectedCountry || !id) return;

          // 条件を国とIDで一致させて対象マーカーを探す
          const targetMarker = markers.find(marker =>
            marker.customCountry === selectedCountry && marker.customId === id
          );
          if (targetMarker) {
            if (infoWindow) {
              infoWindow.close();
              infoWindow = null;
              lastOpenedMarker = null;
            }

            map.setCenter(targetMarker.getPosition());
            map.setZoom(10);

            // クリックイベントを発火
            google.maps.event.trigger(targetMarker, 'click');
          }
        });

        // URLパラメータ処理
        const urlParams = new URLSearchParams(window.location.search);
        const urlLat = parseFloat(urlParams.get('lat'));
        const urlLng = parseFloat(urlParams.get('lng'));
        const urlZoom = parseInt(urlParams.get('zoom'));
        const targetPlace = urlParams.get('place');

        if (!isNaN(urlLat) && !isNaN(urlLng) && !isNaN(urlZoom)) {
          map.setCenter({ lat: urlLat, lng: urlLng });
          map.setZoom(urlZoom);
        }

        if (targetPlace) {
          const decodedPlace = decodeURIComponent(targetPlace);
          setTimeout(() => {
            // titleが遺産名かつ国は問わず（元仕様維持）
            const targetMarker = markers.find(m => m.title === decodedPlace);
            if (targetMarker) {
              map.setCenter(targetMarker.getPosition());
              map.setZoom(10);
              showInfo(targetMarker);
            }
          }, 500);
        }
      });
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap">
  </script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>


