<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>世界遺産マップ</title>
  <style>
    /* あなたの元のCSSはそのまま */
    #map {
      height: 90vh;
      width: 100%;
    }
    .controls {
      margin: 10px;
    }
    select {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <select id="region-select">
      <option value="">-- 地域を選択 --</option>
    </select>
    <select id="country-select" disabled>
      <option value="">-- 国を選択 --</option>
    </select>
  </div>
  <div id="map"></div>

  <script>
    let map;
    let markers = [];
    let heritageData = [];
    let infoWindow;
    let lastOpenedMarker = null;

    const iconColors = {
      "文化遺産": "orange",
      "自然遺産": "green",
      "複合遺産": "blue"
    };

    function showInfo(marker) {
      if (infoWindow) infoWindow.close();
      const data = heritageData.find(h =>
        h.lat === marker.getPosition().lat() &&
        h.lng === marker.getPosition().lng()
      );
      if (!data) return;
      const nameHtml = data.linkUrl
        ? `<a href="${data.linkUrl}" target="_blank">${data.heritageName}</a>`
        : data.heritageName;
      const localNameHtmlJP = data.localNameJP
        ? `<div class="infowindow-localname">${data.localNameJP}</div>`
        : '';
      const localNameHtmlEN = data.localNameEN
        ? `<div class="infowindow-localname">${data.localNameEN}</div>`
        : '';
      const subInfo = `<div class="infowindow-sub">${data.country} / ${data.type} / ${data.year}</div>`;
      const contentHtml = `
        <div>
          <strong>${nameHtml}</strong>
          ${localNameHtmlJP}
          ${localNameHtmlEN}
          ${subInfo}
        </div>
      `;
      infoWindow = new google.maps.InfoWindow({content: contentHtml});
      infoWindow.open(map, marker);
      lastOpenedMarker = marker;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 41.9028, lng: 12.4964},
        zoom: 4,
        gestureHandling: 'greedy',
        tilt: 0
      });

      const savedCenter = localStorage.getItem('mapCenter');
      const savedZoom = localStorage.getItem('mapZoom');
      if (savedCenter && savedZoom) {
        const center = JSON.parse(savedCenter);
        map.setCenter(center);
        map.setZoom(parseInt(savedZoom));
      }

      map.addListener('center_changed', () => {
        localStorage.setItem('mapCenter', JSON.stringify(map.getCenter().toJSON()));
      });
      map.addListener('zoom_changed', () => {
        localStorage.setItem('mapZoom', map.getZoom());
      });

      fetch('places.csv')
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split('\n').slice(1);
          const regionCountryMap = {};
          const countryHeritageMap = {};

          rows.forEach(row => {
            const columns = row.split(',');
            const id = columns[0];
            const region = columns[1];
            const country = columns[2];
            const heritageName = columns[3];
            const lat = parseFloat(columns[4]);
            const lng = parseFloat(columns[5]);
            const type = columns[6].trim();
            const rawYear = columns[7]?.trim() || "";
            let year = "";
            const match = rawYear.match(/\d{4}/);
            if (match) {
              year = match[0] + "年";
            } else {
              year = rawYear;
            }
            const localNameJP = columns[8]?.trim();
            const localNameEN = columns[9]?.trim();
            const linkUrl = columns[10]?.trim();

            heritageData.push({id, region, country, heritageName, lat, lng, type, year, localNameJP, localNameEN, linkUrl});

            if (!regionCountryMap[region]) regionCountryMap[region] = new Set();
            regionCountryMap[region].add(country);

            if (!countryHeritageMap[country]) countryHeritageMap[country] = {};
            countryHeritageMap[country][heritageName] = id;
          });

          // ✅ 総件数を地域選択ボックスに表示
          const totalCount = heritageData.length;
          const regionSelect = document.getElementById('region-select');
          if (regionSelect && regionSelect.options.length > 0) {
            regionSelect.options[0].textContent = `-- 地域を選択 -- (${totalCount})`;
          }

          heritageData.forEach(({id, region, country, heritageName, lat, lng, type}) => {
            const label = id.toString();
            const color = iconColors[type] || "gray";
            const marker = new google.maps.Marker({
              position: {lat, lng},
              map,
              label: {
                text: label,
                color: 'black',
                fontSize: '12px',
                fontWeight: 'normal'
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: color,
                fillOpacity: 1,
                strokeColor: 'black',
                strokeWeight: 1,
                scale: 10
              },
              title: heritageName,
              customRegion: region,
              customCountry: country,
              customId: id
            });
            marker.addListener('click', () => showInfo(marker));
            markers.push(marker);
          });
        });
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap" async defer></script>
</body>
</html>

