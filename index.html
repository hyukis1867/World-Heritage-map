<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>地図マーカー with CSV</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <input type="file" id="csvFile" accept=".csv">
  <div id="map"></div>

  <script>
    let map;
    let infoWindow;
    const markers = [];

    function isMobile() {
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    function initMap() {
      const savedLat = parseFloat(localStorage.getItem("mapCenterLat"));
      const savedLng = parseFloat(localStorage.getItem("mapCenterLng"));
      const savedZoom = parseInt(localStorage.getItem("mapZoom"), 10);

      const defaultLatLng = {
        lat: savedLat || 35.681236,
        lng: savedLng || 139.767125,
      };
      const defaultZoom = savedZoom || 5;

      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLatLng,
        zoom: defaultZoom,
        gestureHandling: isMobile() ? "greedy" : "auto",
        fullscreenControl: false,
        streetViewControl: false,
        mapTypeControl: false
      });

      infoWindow = new google.maps.InfoWindow();

      map.addListener("idle", () => {
        const center = map.getCenter();
        localStorage.setItem("mapCenterLat", center.lat());
        localStorage.setItem("mapCenterLng", center.lng());
        localStorage.setItem("mapZoom", map.getZoom());
      });

      document.getElementById("csvFile").addEventListener("change", handleFileSelect);
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        for (const line of lines) {
          const [name, latStr, lngStr] = line.split(",");
          const lat = parseFloat(latStr);
          const lng = parseFloat(lngStr);
          if (!name || isNaN(lat) || isNaN(lng)) continue;

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map,
            title: name,
          });

          marker.addListener("click", () => {
            if (infoWindow.getMap()) {
              infoWindow.close();
              if (infoWindow.anchor === marker) return;
            }
            infoWindow.setContent(name);
            infoWindow.open(map, marker);
          });

          markers.push(marker);
        }
      };
      reader.readAsText(file, "UTF-8");
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap">
  </script>
</body>
</html>

