<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>世界遺産マップ</title>
  <style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  .infowindow-localname {
    text-align: right;
    font-size: 90%;
    color: #555;
    margin-top: 2px;
  }
  .infowindow-sub {
    text-align: right;
    font-size: 85%;
    color: #444;
    margin-top: 4px;
  }
  .gm-style-iw button.gm-ui-hover-effect {
    display: none !important;
  }
  #dropdown-container {
    position: absolute;
    top: 60px;
    left: 10px;
    z-index: 5;
    background: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
  }
  #dropdown-container select {
    margin-bottom: 0px;
    width: 200px;
    font-size: 14px;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="dropdown-container">
    <div id="region-box" style="margin-bottom: 2px;">
      <select id="region-select">
        <option value="">-- 地域を選択 --</option>
      </select>
    </div>
    <div id="country-box" style="display: none; margin-bottom: 2px;">
      <select id="country-select">
        <option value="">-- 国を選択 --</option>
      </select>
    </div>
    <div id="heritage-box" style="display: none;">
      <select id="heritage-select">
        <option value="">-- 遺産を選択 --</option>
      </select>
    </div>
  </div>

  <script>
let map, markers=[], infoWindow=null, lastOpenedMarker=null, heritageData=[], markerCluster=null;

const iconColors = {
  "文化遺産": "orange",
  "自然遺産": "limegreen",
  "複合遺産": "deepskyblue"
};

function showInfo(marker){
  if(infoWindow) infoWindow.close();
  const data = heritageData.find(h=>h.lat===marker.getPosition().lat()&&h.lng===marker.getPosition().lng());
  if(!data) return;
  const nameHtml = data.linkUrl?`<a href="${data.linkUrl}" target="_blank">${data.heritageName}</a>`:data.heritageName;
  const localNameHtmlJP = data.localNameJP?`<div class="infowindow-localname">${data.localNameJP}</div>`:'';
  const localNameHtmlEN = data.localNameEN?`<div class="infowindow-localname">${data.localNameEN}</div>`:'';
  const subInfo = `<div class="infowindow-sub">${data.country} / ${data.type} / ${data.year}</div>`;
  infoWindow = new google.maps.InfoWindow({content:`<div><strong>${nameHtml}</strong>${localNameHtmlJP}${localNameHtmlEN}${subInfo}</div>`});
  infoWindow.open(map,marker);
  lastOpenedMarker = marker;
}

// CSVパーサー
function parseCSVLine(text){
  const result=[]; let current=''; let insideQuotes=false;
  for(let i=0;i<text.length;i++){
    const char=text[i];
    if(char==='"') insideQuotes=!insideQuotes;
    else if(char===','&&!insideQuotes){result.push(current.trim());current='';}
    else current+=char;
  }
  result.push(current.trim());
  return result;
}

function initMap(){
  map=new google.maps.Map(document.getElementById('map'),{center:{lat:41.9028,lng:12.4964},zoom:4,gestureHandling:'greedy',tilt:0});
  const savedCenter=localStorage.getItem('mapCenter');
  const savedZoom=localStorage.getItem('mapZoom');
  if(savedCenter&&savedZoom){map.setCenter(JSON.parse(savedCenter));map.setZoom(parseInt(savedZoom));}
  map.addListener('center_changed',()=>localStorage.setItem('mapCenter',JSON.stringify(map.getCenter().toJSON())));
  map.addListener('zoom_changed',()=>localStorage.setItem('mapZoom',map.getZoom()));

  fetch('places.csv').then(r=>r.text()).then(csv=>{
    const rows=csv.trim().split('\n').slice(1);
    const regionCountryMap={}, countryHeritageMap={}, regionCountryIDsMap={}, globalUniqueIDs=new Set();
    rows.forEach(row=>{
      const cols=parseCSVLine(row);
      const id=cols[0].trim(), region=cols[1].trim(), country=cols[2].trim(), heritageName=cols[3].trim();
      const lat=parseFloat(cols[4]), lng=parseFloat(cols[5]), type=cols[6].trim();
      const rawYear=cols[7]?.trim()||"", year=rawYear.match(/\d{4}/)?rawYear.match(/\d{4}/)[0]+"年":rawYear;
      const localNameJP=cols[8]?.trim(), localNameEN=cols[9]?.trim(), linkUrl=cols[10]?.trim();
      const gradeRaw=cols[11]?.trim()||"", gradeArray=gradeRaw.replace(/["']/g,'').split(/[、,／\/]/).map(g=>g.trim()).filter(g=>g!==''), grade=gradeArray.join(',');

      heritageData.push({id,region,country,heritageName,lat,lng,type,year,localNameJP,localNameEN,linkUrl,grade});

      if(!regionCountryMap[region]) regionCountryMap[region]=new Set();
      regionCountryMap[region].add(country);

      if(!countryHeritageMap[country]) countryHeritageMap[country]={};
      if(!countryHeritageMap[country][id]) countryHeritageMap[country][id]={id,heritageName,grade};

      if(!regionCountryIDsMap[region]) regionCountryIDsMap[region]={};
      if(!regionCountryIDsMap[region][country]) regionCountryIDsMap[region][country]=new Set();
      regionCountryIDsMap[region][country].add(id);

      const color=iconColors[type]||"gray";
      const marker=new google.maps.Marker({
        position:{lat,lng},
        map,
        label:{text:id.toString(),color:'black',fontSize:'12px',fontWeight:'normal'},
        icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:color,fillOpacity:1,strokeColor:'black',strokeWeight:1,scale:10},
        title:heritageName,
        customRegion:region,
        customCountry:country,
        customId:id
      });
      marker.addListener('click',()=>{if(lastOpenedMarker===marker){if(infoWindow){infoWindow.close();infoWindow=null;lastOpenedMarker=null;}}else showInfo(marker);});
      markers.push(marker);
    });

    markerCluster = new markerClusterer.MarkerClusterer({map,markers,maxZoom:10,onClusterClick:()=>false});

    const regionSelect=document.getElementById('region-select');
    const countrySelect=document.getElementById('country-select');
    const heritageSelect=document.getElementById('heritage-select');

    function updateCluster(){markerCluster.clearMarkers();markerCluster.addMarkers(markers.filter(m=>m.getVisible()));}

    regionSelect.addEventListener('change',()=>{
      const sel=regionSelect.value;
      document.getElementById("country-box").style.display=sel?"block":"none";
      document.getElementById("heritage-box").style.display="none";
      countrySelect.innerHTML='<option value="">-- 国を選択 --</option>';
      countrySelect.disabled=!sel;
      heritageSelect.innerHTML='<option value="">-- 遺産を選択 --</option>';
      heritageSelect.disabled=true;
      markers.forEach(m=>m.setVisible(!sel||m.customRegion===sel));
      updateCluster();
    });

    countrySelect.addEventListener('change',()=>{
      const sel=countrySelect.value;
      document.getElementById("heritage-box").style.display=sel?"block":"none";
      heritageSelect.innerHTML='<option value="">-- 遺産を選択 --</option>';
      heritageSelect.disabled=!sel;
      markers.forEach(m=>m.setVisible(!sel||m.customCountry===sel));
      updateCluster();
    });

    heritageSelect.addEventListener('change',()=>{
      const sel=heritageSelect.value;
      if(!sel) return;
      const target=markers.find(m=>m.customId===sel);
      if(target){map.setCenter(target.getPosition());map.setZoom(10);google.maps.event.trigger(target,'click');}
    });
  });
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap"></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>
